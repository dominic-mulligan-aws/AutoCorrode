name: I/R

permissions:
  contents: read

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  basic:
    name: Basic test (HOL)
    runs-on: ubuntu-latest
    container:
      image: makarius/isabelle:Isabelle2025-2
      options: --user root

    steps:
    - uses: actions/checkout@v4

    - name: Setup Isabelle
      uses: ./.github/actions/setup-isabelle-action

    - name: Install dependencies
      run: |
        apt-get update -qq && apt-get install -y -qq python3 python3-pip python3-venv > /dev/null
        pip3 install --break-system-packages prompt_toolkit

    - name: Set Isabelle environment
      run: |
        ISABELLE_BIN=/home/isabelle/Isabelle/bin/isabelle
        echo "ISABELLE=$ISABELLE_BIN" >> $GITHUB_ENV

    - name: Build HOL heap
      run: $ISABELLE build -b HOL

    - name: Test ir.ML via console
      run: python3 ir/test_console.py --isabelle $ISABELLE --session HOL

    - name: Test repl.py TCP server
      run: python3 ir/test_repl.py --isabelle $ISABELLE --session HOL

  basic-no-prompt-toolkit:
    name: Basic test (HOL, no prompt_toolkit)
    runs-on: ubuntu-latest
    container:
      image: makarius/isabelle:Isabelle2025-2
      options: --user root

    steps:
    - uses: actions/checkout@v4

    - name: Setup Isabelle
      uses: ./.github/actions/setup-isabelle-action

    - name: Install dependencies (no prompt_toolkit)
      run: apt-get update -qq && apt-get install -y -qq python3 > /dev/null

    - name: Set Isabelle environment
      run: |
        ISABELLE_BIN=/home/isabelle/Isabelle/bin/isabelle
        echo "ISABELLE=$ISABELLE_BIN" >> $GITHUB_ENV

    - name: Build HOL heap
      run: $ISABELLE build -b HOL

    - name: Test repl.py TCP server (implicit server-only via missing prompt_toolkit)
      run: python3 ir/test_repl.py --isabelle $ISABELLE --session HOL

    - name: Test repl.py TCP server (explicit --server-only)
      run: python3 ir/test_repl.py --isabelle $ISABELLE --session HOL --server-only

  record_theories:
    name: Build with record_theories
    runs-on: ubuntu-latest
    container:
      image: makarius/isabelle:Isabelle2025-2
      options: --user root

    steps:
    - uses: actions/checkout@v4

    - name: Setup Isabelle
      uses: ./.github/actions/setup-isabelle-action

    - name: Install dependencies
      run: |
        apt-get update -qq && apt-get install -y -qq python3 python3-pip python3-venv > /dev/null
        pip3 install --break-system-packages prompt_toolkit

    - name: Set Isabelle environment
      run: |
        ISABELLE_BIN=/home/isabelle/Isabelle/bin/isabelle
        echo "ISABELLE=$ISABELLE_BIN" >> $GITHUB_ENV

    - name: Build HOL heap with record_theories
      run: $ISABELLE build -f -b -o record_theories=true HOL

    - name: Test source commands are available
      run: python3 ir/test_console.py --isabelle $ISABELLE --session HOL --require-source

    - name: Test repl.py with recorded segments
      run: python3 ir/test_repl.py --isabelle $ISABELLE --session HOL --require-source

  docker:
    name: Docker (${{ matrix.config.name }}, ${{ matrix.runner }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        runner: [ubuntu-latest, ubuntu-24.04-arm]
        config:
          - name: local
            dockerfile: ir/docker/Dockerfile
            tag: isabelle-repl:local
            build_args: ""
          - name: standalone
            dockerfile: ir/docker/Dockerfile.standalone
            tag: isabelle-repl:standalone
            build_args: "--build-arg AUTOCORRODE_BRANCH=${{ github.head_ref || github.ref_name }} --build-arg AUTOCORRODE_REPO=${{ github.event.pull_request.head.repo.clone_url || format('https://github.com/{0}.git', github.repository) }}"
    steps:
      - uses: actions/checkout@v4
      - run: docker build -t ${{ matrix.config.tag }} -f ${{ matrix.config.dockerfile }} ${{ matrix.config.build_args }} .

      - name: Test with server-only (full test suite)
        run: |
          docker run -d --name test-${{ matrix.config.name }}-suite ${{ matrix.config.tag }} \
            python3 /opt/AutoCorrode/ir/repl.py \
              --session HOL --host 0.0.0.0 --isabelle /usr/local/bin/isabelle --server-only
          sleep 30
          docker logs test-${{ matrix.config.name }}-suite
          docker exec test-${{ matrix.config.name }}-suite python3 /opt/AutoCorrode/ir/test_repl.py \
            --isabelle /usr/local/bin/isabelle --session HOL
          docker stop test-${{ matrix.config.name }}-suite
          docker rm test-${{ matrix.config.name }}-suite

      - name: Test default entrypoint (REPL + MCP)
        run: |
          docker run -d -p 9147:9147 -p 9148:9148 --name test-${{ matrix.config.name }}-default ${{ matrix.config.tag }}
          # Wait for REPL to be fully ready (retry actual command, not just TCP connect)
          for i in $(seq 1 60); do
            if python3 -c "
          import socket
          s = socket.create_connection(('127.0.0.1', 9147), timeout=2)
          s.sendall(b'Ir.help ();\n')
          buf = b''
          while b'<<DONE>>' not in buf:
              chunk = s.recv(4096)
              if not chunk: break
              buf += chunk
          s.close()
          assert b'Ir.init' in buf
          " 2>/dev/null; then echo "REPL ready at attempt $i"; break; fi
            sleep 2
          done
          docker logs test-${{ matrix.config.name }}-default
          # Test REPL via TCP
          python3 -c "
          import socket
          s = socket.create_connection(('127.0.0.1', 9147), timeout=30)
          s.sendall(b'Ir.theories ();\n')
          buf = b''
          while b'<<DONE>>' not in buf:
              buf += s.recv(4096)
          s.close()
          assert b'Main' in buf, f'Expected Main in output: {buf[:200]}'
          print('REPL OK')
          "
          # Test MCP via HTTP (retry until ready)
          python3 -c "
          import urllib.request, json, time
          for attempt in range(30):
              try:
                  req = urllib.request.Request('http://127.0.0.1:9148/mcp',
                      data=json.dumps({'jsonrpc':'2.0','id':1,'method':'initialize',
                          'params':{'protocolVersion':'2024-11-05','capabilities':{},
                          'clientInfo':{'name':'ci','version':'1'}}}).encode(),
                      headers={'Content-Type':'application/json',
                               'Accept':'application/json, text/event-stream'})
                  resp = urllib.request.urlopen(req, timeout=10)
                  body = resp.read().decode()
                  assert 'I/R REPL' in body, f'Unexpected MCP response: {body[:200]}'
                  print(f'MCP OK (attempt {attempt+1})')
                  break
              except Exception:
                  time.sleep(2)
          else:
              raise RuntimeError('MCP server not ready after 60s')
          "
          docker stop test-${{ matrix.config.name }}-default
          docker rm test-${{ matrix.config.name }}-default
