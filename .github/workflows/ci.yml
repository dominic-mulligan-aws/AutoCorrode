# SPDX-License-Identifier: MIT

name: CI
permissions:
  contents: read
on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-markdown-link:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
    - uses: gaurav-nelson/github-action-markdown-link-check@3c3b66f1f7d0900e37b71eca45b63ea9eedfce31 # v1.0.17

  build:
    runs-on: ubuntu-latest
    container:
      image: makarius/isabelle:Isabelle2025-2
      options: --user root

    steps:
      - name: Checkout AutoCorrode
        uses: actions/checkout@v3

      - name: Setup Isabelle
        uses: ./.github/actions/setup-isabelle-action

      # Build with HTML documentation, to make sure we can deploy to pages on merge
      - name: Build AutoCorrode
        run: |
          $ISABELLE_HOME/bin/isabelle build -v -b -d . -o browser_info -d $AFP_COMPONENT_BASE/Word_Lib AutoCorrode

  iq-build:
    runs-on: ubuntu-latest
    container:
      image: makarius/isabelle:Isabelle2025-2
      options: --user root

    steps:
      - name: Checkout AutoCorrode
        uses: actions/checkout@v3

      - name: Setup Isabelle
        uses: ./.github/actions/setup-isabelle-action

      - name: Setup dependencies for I/Q build
        run: |
          apt install -y make
          echo "ISABELLE_HOME=/home/isabelle/Isabelle" >> $GITHUB_ENV
          echo "JAVA_HOME=/home/isabelle/Isabelle/contrib/jdk-21.0.9/x86_64-linux/" >> $GITHUB_ENV
          echo "PATH=/home/isabelle/Isabelle/contrib/jdk-21.0.9/x86_64-linux/bin:$PATH" >> $GITHUB_ENV

      - name: Build I/Q plugin
        run: |
          make -C iq

      - name: Install I/Q plugin
        run: |
          make -C iq install

      - name: Build I/P plugin
        run: |
          cd ip/ip_plugin
          make build ISABELLE_HOME=$ISABELLE_HOME

      - name: Install I/P plugin
        run: |
          cd ip/ip_plugin
          make install ISABELLE_HOME=$ISABELLE_HOME

  ip-build:
    runs-on: ubuntu-latest
    container:
      image: makarius/isabelle:Isabelle2025-2
      options: --user root

    steps:
      - name: Checkout AutoCorrode
        uses: actions/checkout@v3

      - name: Setup Isabelle
        uses: ./.github/actions/setup-isabelle-action

      - name: Setup dependencies for I/P build
        run: |
          apt install -y make
          echo "ISABELLE_HOME=/home/isabelle/Isabelle" >> $GITHUB_ENV
          echo "JAVA_HOME=/home/isabelle/Isabelle/contrib/jdk-21.0.9/x86_64-linux/" >> $GITHUB_ENV
          echo "PATH=/home/isabelle/Isabelle/contrib/jdk-21.0.9/x86_64-linux/bin:$PATH" >> $GITHUB_ENV

      - name: Build I/P plugin
        run: |
          cd ip/ip_plugin
          make build ISABELLE_HOME=$ISABELLE_HOME

      - name: Install I/P plugin
        run: |
          cd ip/ip_plugin
          make install ISABELLE_HOME=$ISABELLE_HOME

  ip-test:
    runs-on: ubuntu-latest
    container:
      image: makarius/isabelle:Isabelle2025-2
      options: --user root

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: apt-get update -qq && apt-get install -y -qq openssh-server rsync > /dev/null

    - name: Set up SSH to localhost
      run: |
        ssh-keygen -t ed25519 -N '' -f /root/.ssh/id_ed25519
        cat /root/.ssh/id_ed25519.pub >> /root/.ssh/authorized_keys
        chmod 600 /root/.ssh/authorized_keys
        mkdir -p /run/sshd && /usr/sbin/sshd
        ssh -o StrictHostKeyChecking=no root@localhost true

    - name: Setup Isabelle
      uses: ./.github/actions/setup-isabelle-action

    - name: Build HOL heap (local)
      run: |
        $ISABELLE components -u $AFP_COMPONENT_BASE/Word_Lib
        $ISABELLE build -b HOL

    - name: Configure I/P remote (localhost, fresh install + push heaps)
      run: |
        ip/configure-remote.py setup root@localhost \
          --local-isabelle $ISABELLE_HOME \
          --remote-isabelle /root/Isabelle-remote \
          --ml-platform localhost-test

    - name: Generate ISABELLE_REMOTE flags
      run: |
        FLAGS=$(ip/configure-remote.py run root@localhost \
          --local-isabelle $ISABELLE_HOME \
          --remote-isabelle /root/Isabelle-remote \
          --ml-platform localhost-test)
        echo "ISABELLE_REMOTE=$FLAGS" >> $GITHUB_ENV

    - name: Build AutoCorrode via I/P proxy
      run: |
        eval $ISABELLE build $ISABELLE_REMOTE -v -d . AutoCorrode || true

    - name: Verify proxy was used
      run: |
        grep -q "Remote command" /tmp/ml_proxy.log
        echo "=== Proxy log tail ==="
        tail -20 /tmp/ml_proxy.log

  isabelle-assistant:
    runs-on: ubuntu-latest
    container:
      image: makarius/isabelle:Isabelle2025-2
      options: --user root

    steps:
    - uses: actions/checkout@v4

    - name: Install build tools
      run: apt-get update -qq && apt-get install -y -qq make curl > /dev/null

    - name: Set Isabelle environment
      run: |
        ISABELLE_HOME=$(/home/isabelle/Isabelle/bin/isabelle getenv -b ISABELLE_HOME)
        echo "ISABELLE_HOME=$ISABELLE_HOME" >> $GITHUB_ENV
        JAVA_HOME=$(/home/isabelle/Isabelle/bin/isabelle getenv -b JAVA_HOME)
        echo "JAVA_HOME=$JAVA_HOME" >> $GITHUB_ENV
        echo "$JAVA_HOME/bin" >> $GITHUB_PATH

    - name: Fetch dependencies
      run: |
        cd isabelle-assistant
        ./fetch-deps.sh

    - name: Build I/Q and Assistant plugins
      run: |
        cd isabelle-assistant
        make all ISABELLE_HOME=$ISABELLE_HOME

    - name: Run tests
      run: |
        cd isabelle-assistant
        make test ISABELLE_HOME=$ISABELLE_HOME

    - name: Build I/P plugin
      run: |
        cd ip/ip_plugin
        make build ISABELLE_HOME=$ISABELLE_HOME
